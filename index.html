<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NCAA Scouting Dashboard (MBB/WBB)</title>

  <!-- XLSX: try CDN, fallback to local file next to this HTML -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    (function(){
      if (window.XLSX) return;
      const s = document.createElement('script');
      s.src = './xlsx.full.min.js';  // place xlsx.full.min.js in the same folder as this HTML
      s.onload = () => console.log('Loaded local xlsx.full.min.js');
      s.onerror = () => console.warn('Failed to load local xlsx.full.min.js');
      document.head.appendChild(s);
    })();
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#001c3d;--bg2:#002952;--card:rgba(0,42,88,.65);--card-solid:#002a58;
      --line:rgba(255,210,0,.12);--line2:rgba(255,210,0,.06);
      --text:#f0f4ff;--muted:#8eadd4;
      --accent:#FFD200;--accent2:#ffe566;--accent-glow:rgba(255,210,0,.10);--accent-glow2:rgba(255,210,0,.04);
      --good:#34d399;--warn:#fbbf24;--bad:#f87171;--chip:#0a3a79;--r:14px;
    }
    *{box-sizing:border-box;margin:0}
    html{scroll-behavior:smooth;overflow-x:hidden}
    body{font-family:'Plus Jakarta Sans',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);
      background-image:radial-gradient(ellipse 80% 60% at 20% 0%,rgba(0,62,126,.5) 0%,transparent 60%),radial-gradient(ellipse 60% 50% at 90% 100%,rgba(0,40,80,.4) 0%,transparent 50%);
      background-attachment:fixed;min-height:100vh;overflow-x:hidden}
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:rgba(0,20,50,.4)}
    ::-webkit-scrollbar-thumb{background:rgba(255,210,0,.25);border-radius:3px}
    ::-webkit-scrollbar-thumb:hover{background:rgba(255,210,0,.45)}
    header{padding:20px 24px 16px;border-bottom:1px solid var(--line);background:rgba(0,30,62,.7);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);position:sticky;top:0;z-index:30}
    h1{font-size:20px;font-weight:800;letter-spacing:-.3px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:fadeDown .5s ease-out both}
    .sub{color:var(--muted);font-size:12.5px;line-height:1.5;margin-top:4px;animation:fadeDown .5s .05s ease-out both}
    .wrap{padding:20px;max-width:1260px;margin:0 auto;animation:fadeUp .4s .1s ease-out both;overflow:hidden}
    .topbar{display:flex;gap:12px;align-items:end;flex-wrap:wrap;justify-content:space-between}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}
    input[type="file"]{color:var(--muted)}
    select,input[type="number"],input[type="text"]{background:rgba(0,15,40,.7);color:var(--text);border:1px solid var(--line);border-radius:10px;padding:9px 12px;outline:none;font-family:inherit;font-size:13px;transition:border-color .2s,box-shadow .2s}
    select:focus,input:focus{border-color:rgba(255,210,0,.45);box-shadow:0 0 0 3px var(--accent-glow)}
    input[type="number"]{width:100px}
    .search{flex:1;min-width:0;width:100%}
    button{font-family:inherit;font-size:13px;font-weight:700;border:none;border-radius:10px;padding:9px 16px;cursor:pointer;position:relative;overflow:hidden;background:linear-gradient(135deg,var(--accent),#e6be00);color:#001c3d;box-shadow:0 4px 16px rgba(255,210,0,.2),inset 0 1px 0 rgba(255,255,255,.25);transition:transform .15s,box-shadow .15s,filter .15s}
    button:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(255,210,0,.3)}
    button:active{transform:translateY(0);box-shadow:0 2px 8px rgba(255,210,0,.15)}
    button.secondary{background:rgba(0,15,40,.6);border:1px solid var(--line);color:var(--text);box-shadow:none}
    button.secondary:hover{border-color:rgba(255,210,0,.4);background:rgba(0,20,50,.8);transform:translateY(-1px)}
    button.primary{background:linear-gradient(135deg,var(--accent),#e6be00);color:#001c3d;box-shadow:0 4px 16px rgba(255,210,0,.2),inset 0 1px 0 rgba(255,255,255,.25)}
    button.primary:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(255,210,0,.3);filter:brightness(1.05)}
    button:disabled{opacity:.4;cursor:not-allowed;transform:none!important;filter:none!important}
    .grid{display:grid;grid-template-columns:1.3fr .7fr;gap:16px;margin-top:16px}
    .grid>*{min-width:0}
    @media(max-width:1020px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:0 8px 32px rgba(0,0,0,.25),inset 0 1px 0 rgba(255,255,255,.03);transition:border-color .25s;overflow:hidden}
    .card:hover{border-color:rgba(255,210,0,.2)}
    .pill{font-size:11.5px;font-weight:500;color:var(--muted);border:1px solid var(--line);padding:6px 12px;border-radius:999px;transition:all .2s}
    .pill.active,.seg button.active{border-color:rgba(255,210,0,.6)!important;background:var(--accent-glow)!important;color:var(--accent)!important}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
    .badge strong{color:var(--text);font-weight:700}
    .chip{display:inline-flex;align-items:center;gap:7px;padding:6px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(0,15,40,.5);color:var(--text);font-size:12px;font-weight:700;transition:border-color .2s}
    .chip:hover{border-color:rgba(255,210,0,.3)}
    .chip .dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
    .chipRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .kpis{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .kpis .pill{background:var(--accent-glow2)}
    .kpis b{color:var(--accent);font-weight:700}
    .warnBox{display:none;margin-top:12px;padding:12px 16px;border-radius:var(--r);border:1px solid rgba(248,113,113,.3);background:rgba(50,10,10,.6);color:#fca5a5;font-size:12px;line-height:1.5;backdrop-filter:blur(8px)}
    .hint{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.55;opacity:.85}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{background:rgba(0,15,40,.5);border:1px solid var(--line);color:var(--muted);border-radius:999px;padding:7px 14px;cursor:pointer;font-size:12px;font-weight:700;transition:all .2s}
    .tab:hover{border-color:rgba(255,210,0,.3);color:var(--text)}
    .tab.active{border-color:var(--accent);color:var(--accent);background:var(--accent-glow);box-shadow:0 0 12px rgba(255,210,0,.1)}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:var(--r);border:1px solid var(--line);table-layout:fixed}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line2);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    th{position:sticky;top:0;background:rgba(0,18,48,.95);text-align:left;color:var(--muted);cursor:pointer;z-index:1;font-weight:700;font-size:10.5px;text-transform:uppercase;letter-spacing:.4px;transition:color .15s}
    th:hover{color:var(--accent)}
    tr:last-child td{border-bottom:none}
    tr{transition:background .12s}
    tr:hover td{background:rgba(255,210,0,.03)}
    .statLink{color:var(--accent);text-decoration:none;cursor:pointer;font-weight:600;transition:opacity .15s}
    .statLink:hover{opacity:.8}
    a,.statLink{color:var(--accent)!important}
    .scrollY{max-height:560px;overflow:auto;border-radius:var(--r);border:1px solid var(--line);-webkit-overflow-scrolling:touch}
    .scrollY table{border:none;border-radius:0;table-layout:auto}
    .link{color:var(--accent);text-decoration:none;cursor:pointer;font-weight:600;transition:opacity .15s}
    .link:hover{opacity:.8;text-decoration:underline}
    .rightstack{display:flex;flex-direction:column;gap:16px;min-width:0}
    .weights{max-height:300px;overflow:auto;border-radius:var(--r);border:1px solid var(--line)}
    .weights table{border:none;border-radius:0;table-layout:auto}
    .weights th{top:0}
    .dirIcon{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:10px;border:1px solid var(--line);background:rgba(0,15,40,.5);color:var(--text);font-weight:800;font-size:14px}
    .dirIcon.up{color:var(--good)}.dirIcon.down{color:var(--bad)}
    .dirIcon.up::after{content:"‚Üë"}.dirIcon.down::after{content:"‚Üì"}.dirIcon span{display:none}
    code{background:rgba(0,15,40,.6);padding:3px 8px;border-radius:8px;border:1px solid var(--line);font-size:12px}
    .modalBack{position:fixed;inset:0;background:rgba(0,10,25,.7);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modalBack[style*="flex"]{animation:fadeIn .2s ease-out}
    #statBack{z-index:9999;position:fixed;inset:0}
    .modal{width:min(1060px,100%);max-height:90vh;overflow:auto;background:rgba(0,28,61,.97);border:1px solid rgba(255,210,0,.15);border-radius:18px;box-shadow:0 32px 80px rgba(0,0,0,.5),0 0 0 1px rgba(255,255,255,.03) inset;animation:modalSlide .25s ease-out}
    .modalHead{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:12px;align-items:start}
    .modalTitle{font-size:18px;font-weight:800;letter-spacing:-.2px}
    .modalSub{margin:4px 0 0;color:var(--muted);font-size:12.5px}
    .modalBody{padding:20px}
    .close{background:rgba(0,15,40,.6);border:1px solid var(--line);border-radius:10px;color:var(--text);padding:8px 14px;cursor:pointer;font-weight:700;font-size:12px;transition:all .15s}
    .close:hover{border-color:rgba(255,210,0,.4);background:rgba(255,210,0,.08);color:var(--accent);transform:none;box-shadow:none}
    .profileGrid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px}
    @media(max-width:980px){.profileGrid{grid-template-columns:1fr}}
    .panel{border:1px solid var(--line);border-radius:var(--r);overflow:hidden}
    .panelHead{padding:10px 14px;border-bottom:1px solid var(--line);background:rgba(0,18,48,.7);font-weight:700;font-size:11.5px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
    .panelBody{padding:14px}
    .scoreRow{display:flex;justify-content:space-between;gap:12px;align-items:end}
    .big{font-size:28px;font-weight:800;letter-spacing:-.5px;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .muted{color:var(--muted)}.mini{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.4px}
    .statRow{display:flex;justify-content:space-between;gap:10px;padding:9px 14px;border-bottom:1px solid var(--line2);font-size:12.5px}
    .statRow:last-child{border-bottom:none}.statRow:hover{background:rgba(255,210,0,.02)}.statRow .k{color:var(--muted);font-weight:500}
    .bars{display:flex;flex-direction:column;gap:12px}
    .barItem{display:flex;flex-direction:column;gap:5px}
    .barTop{display:flex;justify-content:space-between;gap:10px;font-size:12.5px}.barTop b{font-weight:700}
    .barTrack{height:8px;background:rgba(0,15,40,.6);border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .barFill{height:100%;width:0%;border-radius:999px;transition:width .6s cubic-bezier(.22,1,.36,1)}
    .barMeta{display:flex;justify-content:space-between;font-size:10.5px;color:var(--muted);opacity:.7}
    .learnMoreBtn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:10px;font-size:12px;font-weight:700;background:rgba(255,210,0,.1);border:1px solid rgba(255,210,0,.3);color:var(--accent);text-decoration:none;white-space:nowrap;transition:all .2s}
    .learnMoreBtn:hover{background:rgba(255,210,0,.18);border-color:rgba(255,210,0,.5);transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,210,0,.12)}
    .learnMoreBtn:active{transform:translateY(0)}
    .learnMoreBtn svg{flex-shrink:0}
    /* Conference multiplier panel */
    .confScroll{max-height:280px;overflow:auto;border-radius:var(--r);border:1px solid var(--line)}
    .confScroll table{border:none;border-radius:0;table-layout:auto}
    .confScroll th{top:0}
    .confMult-input{width:64px;text-align:center;padding:6px 4px;font-size:12px;font-weight:700;border-radius:8px}
    .confMult-input:focus{border-color:rgba(255,210,0,.5)}
    .toggleSwitch{position:relative;width:42px;height:24px;cursor:pointer;display:inline-block}
    .toggleSwitch input{opacity:0;width:0;height:0}
    .toggleTrack{position:absolute;inset:0;background:rgba(0,15,40,.7);border:1px solid var(--line);border-radius:999px;transition:background .2s,border-color .2s}
    .toggleSwitch input:checked + .toggleTrack{background:rgba(255,210,0,.25);border-color:rgba(255,210,0,.5)}
    .toggleTrack::after{content:'';position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:var(--muted);transition:transform .2s,background .2s}
    .toggleSwitch input:checked + .toggleTrack::after{transform:translateX(18px);background:var(--accent)}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes modalSlide{from{opacity:0;transform:translateY(16px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
    @media(max-width:640px){.wrap{padding:12px}header{padding:14px 16px 12px}h1{font-size:17px}.card{padding:12px}.modalHead{padding:14px}.modalBody{padding:14px}}
  </style>

</head>
<body>
<header>
  <h1>üèÄ NCAA Scouting Dashboard</h1>
  <p class="sub">
    Click a player to open their full stat profile with percentiles, archetypes, and fit score.
    Uses: <b>MBB Guards</b>, <b>MBB Bigs</b>, <b>WBB Guards MAC</b>, <b>WBB Bigs MAC</b>, plus <b>ScoringWeight</b>.
  </p>
</header>

<div class="wrap">
  <div class="topbar">
    <div class="row">
      <div><label>Data source</label><div class="hint">Google Sheet (auto-loads)</div></div>
      <div>
        <label>API key</label><br/>
        <input id="gsKey" style="display:none" value="AIzaSyAfcKSySow-TBS1uZNHrQX4oc_uiUWwvq8">
      </div>
      <div style="display:flex;flex-direction:column;justify-content:flex-end">
        <button class="primary" id="loadGs">Refresh data</button>
        <div id="gsStatus" style="margin-top:10px;color:#fff;font-family:system-ui;font-size:14px;"></div>
        <div class="hint" style="margin-top:6px">Security: consider restricting your key to Google Sheets API + your domain.</div>
      </div>


      <div>
        <label>League</label><br/>
        <div class="tabs">
          <button class="tab active" data-league="MBB" id="tabMBB">MBB</button>
          <button class="tab" data-league="WBB" id="tabWBB">WBB</button>
        </div>
      </div>

      <div>
        <label>Position rules</label><br/>
        <div class="tabs">
          <button class="tab active" data-pos="Guards" id="tabGuards">Guards</button>
          <button class="tab" data-pos="Bigs" id="tabBigs">Bigs</button>
        </div>
      </div>

      <div>
        <label>Fit preset</label><br/>
        <select id="fitPreset">
          <option value="balanced">Balanced</option>
          <option value="shooting">Shooting</option>
          <option value="playmaking">Playmaking</option>
          <option value="defense">Defense</option>
          <option value="rim">Rim Protection (Bigs)</option>
          <option value="rebounding">Rebounding (Bigs)</option>
        </select>
      </div>

      <div>
        <label>Search</label><br/>
        <input id="search" class="search" type="text" placeholder="Search player / team / conf‚Ä¶" />
      </div>
    </div>

    <div class="row">
      <button id="recalc" disabled>Recalculate</button>
      <button id="export" class="secondary" disabled>Export CSV</button>
    </div>
  </div>

  <div id="warn" class="warnBox"></div>

  <div class="grid">
    <!-- LEFT: Player list -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="badge">Sheet: <strong id="activeSheet">‚Äî</strong></span>
          <span class="badge">Fit: <strong id="activeFit">Balanced</strong></span>
        </div>
        <span class="pill">Sort headers ‚Ä¢ Click player for profile</span>
      </div>

      <div class="kpis">
        <span class="pill">Players: <b id="kpiPlayers">‚Äî</b></span>
        <span class="pill">Stats used: <b id="kpiStats">‚Äî</b></span>
        <span class="pill">Total weight: <b id="kpiTotalW">‚Äî</b></span>
        <span class="pill">Avg PerfScore: <b id="kpiAvgPerf">‚Äî</b></span>
        <span class="pill">Star PerfScore (p): <b id="kpiStarPerf">‚Äî</b></span>
      </div>

      <div style="margin-top:10px" class="scrollY">
        <table>
          <thead>
            <tr id="playersHead"></tr>
          </thead>
          <tbody id="playersBody"></tbody>
        </table>
      </div>

      <div class="hint">
        <b>Percentiles</b> are computed within the currently selected sheet (league+position).
        If a stat is ‚Äúlower is better‚Äù in your weights (Min &gt; Max), percentiles are automatically inverted (so lower = higher percentile).
        <br><br>
        <b>Valuation</b> uses an exponential curve anchored to your average pay and a ‚Äústar‚Äù target:
        <span class="muted">Pred = clamp(min,max, avgPay √ó exp(k √ó (Perf ‚àí avgPerf)))</span>,
        with <span class="muted">k = ln(starValue/avgPay) / (starPerf ‚àí avgPerf)</span>.
        Then a minutes multiplier is applied to avoid low-MP inflation.
      </div>
    </div>

    <!-- RIGHT: Controls -->
    <div class="rightstack">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-size:13px; font-weight:1000">Weights / Min / Max</div>
            <div class="muted" style="font-size:12px;margin-top:4px">Switches with Guards/Bigs automatically.</div>
          </div>
          <div class="row" style="gap:8px">
  <label class="pill" style="display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none">
  <input id="showSelectedOnly" type="checkbox" style="accent-color:#FFD200"/> Selected only
</label>
<label class="pill" title="Optional: allow overriding Higher/Lower direction per stat" style="display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none">
  <input id="advancedDir" type="checkbox" style="accent-color:#FFD200"/> Advanced dir
</label>
</div>
<button id="resetWeights" class="secondary" disabled>Reset</button>
        </div>

        <div class="weights" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="width:46%">Stat</th>
                <th>W</th>
                <th>Min</th>
                <th>Max</th>
                <th style="width:18%">Dir</th>
              </tr>
            </thead>
            <tbody id="weightsBody"></tbody>
          </table>
        </div>
<div class="row" style="justify-content:space-between;align-items:center;margin-top:10px;gap:10px;flex-wrap:wrap">
  <span class="pill">Total weight: <b id="wTotalLocal">‚Äî</b> / 100</span>
  <span class="pill">Remaining: <b id="wRemaining">‚Äî</b></span>
  <span class="pill" id="wOverBox" style="display:none; border-color:#3b2a2a; background:#1a1111; color:#ffd0d0">Over by: <b id="wOver">‚Äî</b></span>
</div>
<div class="hint">Tip: rows with <b>W ‚â† 0</b> are your default selections (highlighted). Direction shows as ‚Üë (higher is better) or ‚Üì (lower is better). This list is pulled from <b>ScoringWeight</b> (your approved scoring metrics).</div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-size:13px; font-weight:1000">Valuation settings</div>
            <div class="muted" style="font-size:12px;margin-top:4px">Editable (MBB/WBB defaults on reset).</div>
          </div>
          <button id="resetVal" class="secondary">Reset</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Average pay</label><br/>
            <input id="avgPay" type="number" step="1000" value="70000">
          </div>
          <div>
            <label>Min pay</label><br/>
            <input id="minPay" type="number" step="1000" value="10000">
          </div>
          <div>
            <label>Max pay</label><br/>
            <input id="maxPay" type="number" step="1000" value="300000">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Star value ($)</label><br/>
            <input id="starValue" type="number" step="5000" value="100000">
          </div>
          <div>
            <label>Star percentile (PerfScore)</label><br/>
            <input id="starPct" type="number" step="0.01" min="0.5" max="0.999" value="0.95">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Minutes adjust</label><br/>
            <select id="mpMode">
              <option value="on" selected>On (min(1, sqrt(MP/MP_p)))</option>
              <option value="off">Off</option>
            </select>
          </div>
          <div>
            <label>MP percentile (p)</label><br/>
            <input id="mpPct" type="number" step="0.01" min="0.5" max="0.999" value="0.95">
          </div>
        </div>

        <div class="hint">
          If you change <b>starValue</b>, you are changing the slope of the curve:
          bigger starValue ‚Üí higher top-end valuations (more spread above average), while keeping average anchored at avgPay.
        </div>
      </div>

      <!-- Conference Multiplier -->
      <div class="card" id="confMultCard">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-size:13px; font-weight:800">Conference multiplier</div>
            <div class="muted" style="font-size:12px;margin-top:4px">Multiplies PerfScore by conference strength. <span id="confMultLeagueNote" style="color:var(--warn)"></span></div>
          </div>
          <div class="row" style="gap:10px">
            <label class="toggleSwitch" title="Toggle conference multiplier on/off">
              <input id="confMultToggle" type="checkbox" checked>
              <span class="toggleTrack"></span>
            </label>
            <button id="resetConfMult" class="secondary" style="padding:7px 12px;font-size:12px">Reset</button>
          </div>
        </div>

        <div id="confMultBody" style="margin-top:12px">
          <div class="confScroll">
            <table>
              <thead>
                <tr>
                  <th style="width:55%">Conference</th>
                  <th>Multiplier</th>
                </tr>
              </thead>
              <tbody id="confMultTableBody"></tbody>
            </table>
          </div>
          <div class="row" style="margin-top:10px;gap:6px;flex-wrap:wrap">
            <span class="pill">Baseline: <b>MAC = 1.00</b></span>
            <span class="pill">Range: <b id="confMultRange">‚Äî</b></span>
          </div>
          <div class="hint">Adjusts PerfScore before valuation. A player in a stronger conference gets a boosted score. Currently <b>MBB only</b> ‚Äî WBB will auto-activate when conference data is added to that sheet.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modalBack" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div>
        <div class="modalTitle" id="mTitle">Player</div>
        <div class="modalSub" id="mSub">‚Äî</div>
        <div class="chipRow" id="mTags"></div>
      </div>
      <div style="display:flex; gap:8px; align-items:start; flex-shrink:0">
        <a id="mLearnMore" href="#" target="_blank" rel="noopener noreferrer" class="learnMoreBtn"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Learn More</a>
        <button class="close" id="mClose">Close</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="profileGrid">
        <div class="panel">
          <div class="panelHead">Overview</div>
          <div class="panelBody">
            <div class="scoreRow">
              <div>
                <div class="muted mini">PerfScore</div>
                <div class="big" id="mScore">‚Äî</div>
              </div>
              <div style="text-align:right">
                <div class="muted mini">Fit score</div>
                <div class="big" id="mFit">‚Äî</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="scoreRow">
              <div>
                <div class="muted mini">Final valuation</div>
                <div class="big" id="mVal">‚Äî</div>
              </div>
              <div style="text-align:right">
                <div class="muted mini">Minutes multiplier</div>
                <div class="big" id="mMult">‚Äî</div>
              </div>
            </div>

            <div id="mConfMultRow" style="margin-top:8px;display:none">
              <div class="scoreRow">
                <div>
                  <div class="muted mini">Conf multiplier</div>
                  <div class="big" id="mConfMult" style="font-size:20px">‚Äî</div>
                </div>
                <div style="text-align:right">
                  <div class="muted mini">Conference</div>
                  <div id="mConfName" style="font-size:14px;font-weight:700;margin-top:2px">‚Äî</div>
                </div>
              </div>
            </div>

            <div class="hint" id="mMeta">‚Äî</div>
            <div class="divider"></div>
            <div class="panel" style="background:rgba(2,18,42,.35); border-color:rgba(27,79,153,.65)">
              <div class="panelHead">Role tag definitions</div>
              <div class="panelBody" id="mRoleDefs" style="display:flex; flex-direction:column; gap:10px"></div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHead">Key percentiles</div>
          <div class="panelBody">
            <div class="bars" id="mBars"></div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="panel">
        <div class="panelHead">All stats</div>
        <div class="panelBody" style="padding:0">
          <div class="panel" style="border:none;border-radius:0" id="mAllStats"></div>
        </div>
      </div>
    </div>
  </div>

</div>
  </div>
</div>

</div>

<script>
  // Surface runtime errors in the UI (so you don't need DevTools)
  window.addEventListener('error', (e) => {
    const box = document.getElementById('warn');
    if(!box) return;
    box.style.display = 'block';
    box.textContent = `JS Error: ${e.message}`;
  });

  window.addEventListener('DOMContentLoaded', () => {
    const sheetEl = document.getElementById('activeSheet');
    if(sheetEl && (sheetEl.textContent||'').trim() === '‚Äî') sheetEl.textContent = 'Ready (upload workbook)';
  });

  // ---------- Helpers ----------

  const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
  const clamp01 = (x) => clamp(x, 0, 1);
  const fmtMoney = (n) => Number.isFinite(n) ? n.toLocaleString(undefined, {style:'currency', currency:'USD', maximumFractionDigits:0}) : '‚Äî';
  const safeNum = (v) => { const x = Number(v); return Number.isFinite(x) ? x : null; };
  // Convert Google Sheets AOA (array-of-arrays) into row objects using header row.
  function aoaToObjects(aoa){
    if(!aoa || !aoa.length) return [];
    const headers = (aoa[0]||[]).map(h => String(h||'').trim());
    const rows = [];
    for(let i=1;i<aoa.length;i++){
      const obj = {};
      const row = aoa[i]||[];
      for(let j=0;j<headers.length;j++){
        const key = headers[j];
        if(!key) continue;
        obj[key] = row[j];
      }
      if(Object.keys(obj).length) rows.push(obj);
    }
    return rows;
  }

  // Unified sheet->AOA for both XLSX worksheets and Google AOA sheets
  // ALWAYS returns array-of-arrays (AOA) so callers can use consistent indexing.
  function sheetToAoa(ws){
    if(!ws) return [];
    if(ws.__aoa) return ws.__aoa;                         // Google Sheets data
    if(typeof XLSX !== 'undefined' && XLSX?.utils?.sheet_to_json){
      return XLSX.utils.sheet_to_json(ws, {header:1});    // XLSX worksheet ‚Üí AOA
    }
    return [];
  }

  // Returns array of row-objects (header-keyed) for either source
  function sheetToJson(ws){
    if(!ws) return [];
    if(ws.__aoa) return aoaToObjects(ws.__aoa);
    if(typeof XLSX !== 'undefined' && XLSX?.utils?.sheet_to_json){
      return XLSX.utils.sheet_to_json(ws);                // XLSX ‚Üí objects
    }
    return [];
  }

  // Percent stats are already stored as decimals (e.g., 0.38 for 38%) in the spreadsheet.
  // No conversion needed.
  function scalePct(stat, x){ return x; }


  // percentile (inclusive) like Excel PERCENTILE.INC
  function percentileInc(arr, p){
    const a = arr.filter(Number.isFinite).slice().sort((x,y)=>x-y);
    if(a.length === 0) return NaN;
    const n = a.length;
    const r = (n - 1) * p + 1;
    const k = Math.floor(r);
    const d = r - k;
    if(k <= 1) return a[0];
    if(k >= n) return a[n-1];
    return a[k-1] + d * (a[k] - a[k-1]);
  }

  // percentile rank (0..1): fraction <= x
  function percentileRank(sortedAsc, x){
    if(!sortedAsc?.length || !Number.isFinite(x)) return NaN;
    // binary search upper bound
    let lo = 0, hi = sortedAsc.length;
    while(lo < hi){
      const mid = (lo + hi) >> 1;
      if(sortedAsc[mid] <= x) lo = mid + 1;
      else hi = mid;
    }
    return lo / sortedAsc.length;
  }

  
  function extractSpreadsheetId(url){
    if(!url) return null;
    const m = String(url).match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
    return m ? m[1] : null;
  }

  
  // ---- Google Sheets defaults (edit once; used for auto-load on GitHub Pages) ----
  const DEFAULT_GS_URL = 'https://docs.google.com/spreadsheets/d/1dDphHKY2lIs1T88TKo6f3n7oUccc4dVYmMlF2Rk1mFk/edit?usp=sharing';
  const DEFAULT_GS_API_KEY = 'AIzaSyAfcKSySow-TBS1uZNHrQX4oc_uiUWwvq8';

  async function loadFromGoogleSheets(url = DEFAULT_GS_URL, apiKey = DEFAULT_GS_API_KEY){
    try{
      const sid = extractSpreadsheetId(url);
      if(!sid) { showWarn('Could not parse spreadsheet ID from the link.'); return; }
      if(!apiKey) { showWarn('Missing API key.'); return; }

      const ranges = [
        'ScoringWeight!A1:G',
        `${SHEET_MAP.MBB.Guards}!A1:ZZ`,
        `${SHEET_MAP.MBB.Bigs}!A1:ZZ`,
        `${SHEET_MAP.WBB.Guards}!A1:ZZ`,
        `${SHEET_MAP.WBB.Bigs}!A1:ZZ`,
      ];

      const qs = ranges.map(r => 'ranges=' + encodeURIComponent(r)).join('&');
      const endpoint = `https://sheets.googleapis.com/v4/spreadsheets/${sid}/values:batchGet?key=${encodeURIComponent(apiKey)}&valueRenderOption=UNFORMATTED_VALUE&majorDimension=ROWS&${qs}`;

      showWarn('Loading from Google Sheets‚Ä¶');
      const res = await fetch(endpoint);
      const data = await res.json();

      if(!res.ok){
        const msg = data?.error?.message || ('Google Sheets API error ('+res.status+')');
        showWarn(msg);
        return;
      }
      if(!data.valueRanges || !data.valueRanges.length){
        showWarn('No data returned from Google Sheets API. Check permissions + sheet names.');
        console.warn('Sheets returned empty data');
        return;
      }

      wb = { SheetNames: [], Sheets: {} };
      data.valueRanges.forEach(vr => {
        const range = vr.range || '';
        // Google Sheets API wraps names with spaces in single quotes, e.g. "'MBB Guards'!A1:ZZ"
        let sheetName = range.split('!')[0] || 'Sheet';
        sheetName = sheetName.replace(/^'(.*)'$/, '$1');   // strip surrounding quotes
        const aoa = vr.values || [];
        wb.SheetNames.push(sheetName);
        wb.Sheets[sheetName] = { __aoa: aoa };
      });

      const need = ['ScoringWeight', ...Object.values(SHEET_MAP.MBB), ...Object.values(SHEET_MAP.WBB)];
      const missing = need.filter(n => !wb.SheetNames.includes(n) && !findSheetLike(n));
      if(missing.length){
        showWarn(`Missing sheet(s): ${missing.join(', ')}. Found: ${wb.SheetNames.join(', ')}`);
      } else {
        clearWarn();
      }

      const ok = loadScoringWeight();
      resetWeightsBtn.disabled = !ok;
      recalcBtn.disabled = false;
      exportBtn.disabled = false;

      applyLeagueDefaults(true);
      renderWeights();
      activeFitEl.textContent = fitPresetEl.options[fitPresetEl.selectedIndex].text;
      reloadActiveSheet();
    }catch(err){
      showWarn(String(err?.message || err));
    }
  }

function waitForXLSX(timeoutMs=5000){
    return new Promise((resolve, reject)=>{
      const start = Date.now();
      const t = setInterval(()=>{
        if(window.XLSX){ clearInterval(t); resolve(true); }
        if(Date.now()-start > timeoutMs){
          clearInterval(t);
          reject(new Error("XLSX library not loaded. Put xlsx.full.min.js next to this HTML."));
        }
      }, 50);
    });
  }

  // ---------- State + DOM ----------
const gsUrlInput = document.getElementById('gsUrl');
  const gsKeyInput = document.getElementById('gsKey');
  const loadGsBtn = document.getElementById('loadGs');
  const recalcBtn = document.getElementById('recalc');
  const exportBtn = document.getElementById('export');
  const resetWeightsBtn = document.getElementById('resetWeights');
  const resetValBtn = document.getElementById('resetVal');
  const searchInput = document.getElementById('search');
  const warn = document.getElementById('warn');
  const fitPresetEl = document.getElementById('fitPreset');

  const weightsBody = document.getElementById('weightsBody');
  const showSelectedOnlyEl = document.getElementById('showSelectedOnly');
  const advancedDirEl = document.getElementById('advancedDir');

  const playersHead = document.getElementById('playersHead');
  const playersBody = document.getElementById('playersBody');
  const activeSheetEl = document.getElementById('activeSheet');
  const activeFitEl = document.getElementById('activeFit');

  const wTotalLocalEl = document.getElementById('wTotalLocal');
  const wRemainingEl = document.getElementById('wRemaining');
  const wOverBoxEl = document.getElementById('wOverBox');
  const wOverEl = document.getElementById('wOver');

  // Click a stat name in the weights table to open its glossary
  weightsBody.addEventListener('click', (e)=>{
    const el = e.target.closest('.statLink');
    if(!el) return;
    const stat = el.getAttribute('data-stat') || el.dataset.stat || el.textContent;
    if(stat) openStatInfo(stat.trim());
  });


  const kpiPlayers = document.getElementById('kpiPlayers');
  const kpiStats = document.getElementById('kpiStats');
  const kpiTotalW = document.getElementById('kpiTotalW');
  const kpiAvgPerf = document.getElementById('kpiAvgPerf');
  const kpiStarPerf = document.getElementById('kpiStarPerf');

  const avgPayEl = document.getElementById('avgPay');
  const minPayEl = document.getElementById('minPay');
  const maxPayEl = document.getElementById('maxPay');
  const starValueEl = document.getElementById('starValue');
  const starPctEl = document.getElementById('starPct');
  const mpModeEl = document.getElementById('mpMode');
  const mpPctEl = document.getElementById('mpPct');

  const modalBack = document.getElementById('modalBack');
  const mClose = document.getElementById('mClose');
  const mTitle = document.getElementById('mTitle');
  const mSub = document.getElementById('mSub');
  const mScore = document.getElementById('mScore');
  const mFit = document.getElementById('mFit');
  const mVal = document.getElementById('mVal');
  const mMult = document.getElementById('mMult');
  const mMeta = document.getElementById('mMeta');
  const mBars = document.getElementById('mBars');
  const mAllStats = document.getElementById('mAllStats');
  const mTags = document.getElementById('mTags');
  // Stat glossary modal elements are queried lazily (modal is appended after the script)


  let wb = null;
  let league = 'MBB';
  let pos = 'Guards';
  let excelWeights = {Guards:[], Bigs:[]};
  let currentWeights = {Guards:[], Bigs:[]};

  let rows = [];
  let computed = [];
  let sort = { key:'ActualValuation_calc', dir:'desc' };

  // All allowable scoring metrics (from ScoringWeight column A)
  let baseStatsAll = [];

  // precomputed stat distributions for percentiles
  let statDist = {};  // {stat: {sorted:[...], invert:boolean}}
  let lastPerfAvg = NaN, lastPerfStar = NaN;

  function normalizeName(s){ return (s||'').toString().trim().toLowerCase().replace(/\s+/g,' '); }
  function findSheetLike(target){
    if(!wb) return null;
    const t = normalizeName(target);
    // exact (case-insensitive, whitespace-normalized)
    for(const name of wb.SheetNames){
      if(normalizeName(name) === t) return name;
    }
    // contains all tokens
    const tokens = t.split(' ').filter(Boolean);
    let best = null, bestScore = -1;
    for(const name of wb.SheetNames){
      const nn = normalizeName(name);
      let score = 0;
      tokens.forEach(tok => { if(nn.includes(tok)) score += 1; });
      // small bonus for prefix match
      if(nn.startsWith(tokens[0]||'')) score += 0.5;
      if(score > bestScore){
        bestScore = score; best = name;
      }
    }
    // require at least half the tokens matched
    if(bestScore >= Math.max(1, tokens.length/2)) return best;
    return null;
  }

  const SHEET_MAP = {

    MBB: {Guards:'MBB Guards', Bigs:'MBB Bigs'},
    WBB: {Guards:'WBB Guards MAC', Bigs:'WBB Bigs MAC'}
  };

  // Fit presets: each is weights on percentile metrics (0..1)
  const FIT_PRESETS = {
    balanced: { 'PPG':1, 'eFG%':1, 'BPM':1, 'WS/40':1, 'DRtg':1, 'APG':1, 'TOPG':1, 'BPG':1, 'SPG':1, 'DR%':1, 'OR%':0.6, 'A/TO':0.8, '3P%':1, 'FT%':0.6, 'ORtg':0.4, '+/-':0.4 },
    shooting: { '3P%':1.3, 'eFG%':1.1, 'FT%':0.8, 'PPG':0.8, 'ORtg':0.4 },
    playmaking: { 'APG':1.2, 'A/TO':1.2, 'TOPG':1.0, 'ORtg':0.6 },
    defense: { 'DRtg':1.2, 'SPG':1.0, 'BPG':1.0, 'DR%':1.0, '+/-':0.6 },
    rim: { 'BPG':1.5, 'DRtg':1.2, 'DR%':1.0, 'DRB/G':0.9 },
    rebounding: { 'DR%':1.4, 'OR%':1.0, 'DRB/G':1.1, 'ORB/G':0.9 }
  };

  function showWarn(msg){
    warn.style.display = 'block';
    warn.textContent = msg;
  }
  function clearWarn(){
    warn.style.display = 'none';
    warn.textContent = '';
  }

  function setActiveTab(el, groupSelector){
    document.querySelectorAll(groupSelector).forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
  }

  // ---------- Excel parsing ----------
  function parseSheetToRows(ws){
    // sheetToJson returns an array of row-objects for both Google and XLSX sources
    const objRows = sheetToJson(ws);
    if(!objRows || !objRows.length) return [];
    // Filter out completely blank rows
    return objRows.filter(obj => {
      return Object.values(obj).some(v => v !== undefined && v !== null && v !== '');
    });
  }

  
  function isLikelyNumericColumn(key){
    const k = (key||'').toString().trim();
    if(!k) return false;
    // exclude obvious text/id columns
    const bad = new Set([
      'Player','Name','Team','School','Conference','Conf','Position','Pos','Class','Yr','Year','ID','URL','Link',
      'Rank','Score','PerfScore','PerfScore_calc','FitScore','FitScore_calc','PredictedValue','PredictedValue_calc',
      'ActualValuation','ActualValuation_calc','MinMultiplier','MinMultiplier_calc','MP_num'
    ]);
    if(k.startsWith('Norm_')) return false; // normalized helper columns from Excel shouldn't be scoring metrics here

    if(bad.has(k)) return false;
    return true;
  }

  function getNumericColumnsFromRows(rowArr){
    if(!rowArr?.length) return [];
    const keys = Object.keys(rowArr[0]);
    const cols = [];
    keys.forEach(k=>{
      if(!isLikelyNumericColumn(k)) return;
      let n=0, ok=0;
      for(let i=0;i<rowArr.length;i++){
        const v = Number(rowArr[i][k]);
        if(rowArr[i][k] === null || rowArr[i][k] === undefined || rowArr[i][k] === '') continue;
        n++;
        if(Number.isFinite(v)) ok++;
      }
      // keep columns that are mostly numeric (>=30% numeric among non-empty)
      if(n >= 10 && ok/n >= 0.30) cols.push(k);
    });
    return cols;
  }

  function minMaxForStat(rowArr, stat){
    let mn = Infinity, mx = -Infinity, count=0;
    for(const r of rowArr){
      const v = Number(r[stat]);
      if(!Number.isFinite(v)) continue;
      count++;
      if(v < mn) mn = v;
      if(v > mx) mx = v;
    }
    if(count < 5) return {min: 0, max: 1, ok:false};
    // If min==max, widen slightly to avoid divide-by-zero normalization.
    if(mn === mx){
      const eps = (Math.abs(mn) || 1) * 0.01;
      mn -= eps; mx += eps;
    }
    return {min: mn, max: mx, ok:true};
  }

  function ensureWeightsCoverStats(forPos, rowArr){
    // Only allow scoring metrics defined in ScoringWeight (column A)
    const allowed = (baseStatsAll || []).slice();
    const existing = currentWeights[forPos] || [];
    const existingSet = new Set(existing.map(x=>x.stat));

    allowed.forEach(stat=>{
      if(existingSet.has(stat)) return;

      // If the stat exists in the data sheet, infer min/max from the column; otherwise default to 0..1
      const mm = (rowArr && rowArr.length && (stat in (rowArr[0]||{}))) ? minMaxForStat(rowArr, stat) : {min:0, max:1, ok:false};
      existing.push({stat, w:0, min:mm.min, max:mm.max, dir: guessDirForStat(stat), _auto:true});
      existingSet.add(stat);
    });

    // Fill missing dir
    existing.forEach(it=>{ if(!it.dir) it.dir = guessDirForStat(it.stat); });

    // Also remove any accidental non-allowed metrics that might have been added by older versions
    const allowedSet = new Set(allowed);
    currentWeights[forPos] = existing.filter(it => allowedSet.has(it.stat));
  }

function loadScoringWeight(){
    excelWeights = {Guards:[], Bigs:[]};
    currentWeights = {Guards:[], Bigs:[]};
    baseStatsAll = [];

    const swName = findSheetLike('ScoringWeight') || 'ScoringWeight';
    const ws = wb.Sheets[swName];
    if(!ws) return false;
    const aoa = sheetToAoa(ws);   // always AOA so we can destructure by position
    for(let i=1;i<aoa.length;i++){
      const [stat, gw, gmin, gmax, bw, bmin, bmax] = aoa[i] || [];
      if(stat){
        const s = String(stat).trim();
        if(s && s.toLowerCase() !== 'total') baseStatsAll.push(s);
      }

      if(!stat) continue;
      if(gw !== undefined && gw !== null && gw !== ''){
        excelWeights.Guards.push({stat:String(stat), w:Number(gw), min:Number(gmin), max:Number(gmax), dir: (Number(gmin) > Number(gmax) ? 'lower' : guessDirForStat(String(stat)))});
      }
      if(bw !== undefined && bw !== null && bw !== ''){
        excelWeights.Bigs.push({stat:String(stat), w:Number(bw), min:Number(bmin), max:Number(bmax), dir: (Number(bmin) > Number(bmax) ? 'lower' : guessDirForStat(String(stat)))});
      }
    }
    // unique and preserve order
    baseStatsAll = Array.from(new Set(baseStatsAll));

    currentWeights.Guards = JSON.parse(JSON.stringify(excelWeights.Guards));
    currentWeights.Bigs = JSON.parse(JSON.stringify(excelWeights.Bigs));
    return true;
  }

  
  // Default direction rules (can be overridden in UI)
  // "lower" means lower is better (percentiles + scoring invert automatically)
  
  // Short glossary for your 19 scoring metrics
  const ROLE_DESCRIPTIONS = {
  // Guards / general
  "Shooter": "Elite perimeter threat. Strong 3P% that bends the defense and creates spacing.",
  "Efficient": "Scores with high efficiency (shot quality + finishing). Converts possessions into points at an above-average rate.",
  "Scorer": "Primary offensive producer. Creates points through shot volume and/or shot creation ability.",
  "Playmaker": "Creates offense for teammates through assists, decision-making, and ball movement.",
  "Low TO": "Protects possessions and makes smart decisions with the ball. Minimizes turnovers relative to usage.",
  "Disruptor": "Creates defensive events ‚Äî steals/deflections/pressure that disrupts actions and generates transition chances.",
  "Defender": "Reliable defensive contributor. Strong defensive impact indicators (e.g., DR% / on-ball pressure proxies).",
  "Impact": "Overall positive influence on winning across efficiency and impact metrics (e.g., BPM / two-way value).",
  "Role Player": "Dependable contributor who supports team structure with effort and situational strengths.",

  // Bigs / frontcourt
  "Rim Protector": "Protects the paint. Deterrs shots at the rim and blocks/contests effectively (high BPG percentile).",
  "Rebounder": "Controls the glass on defense (and sometimes overall). Ends possessions and creates second-chance chances.",
  "Anchor Defender": "Backline defensive organizer. Strong team-defense impact indicators (e.g., elite DRtg percentile).",
  "Efficient Finisher": "High-efficiency scorer around the rim (and on limited touches). Converts looks into points (high eFG% percentile).",
  "Extra Possessions": "Creates additional chances via offensive rebounding and hustle plays (high OR% percentile).",
  "Stretch Big": "Big who spaces the floor. Credible 3PT threat that pulls rim protection away from the paint.",
  "Frontcourt Role": "Role-oriented big. Provides minutes/physicality/screens/rebounding/defense without a standout single elite tag."
};

const STAT_GLOSSARY = {
    'PPG': 'Points per game. Overall scoring volume (pace/role dependent).',
    'FG%': 'Field Goal Percentage. Share of all 2PT+3PT shots made. Doesn‚Äôt account for 3PT value.',
    '3P%': 'Three-Point Percentage. Share of 3PT shots made. Indicates spacing / shooting skill.',
    'FT%': 'Free Throw Percentage. Share of free throws made. Proxy for touch/shooting.',
    'APG': 'Assists per game. Passing/playmaking volume (role dependent).',
    'TOPG': 'Turnovers per game. Ball security; lower is better.',
    'A/TO': 'Assist-to-turnover ratio. Passing efficiency & decision-making; higher is better.',
    'ORB/G': 'Offensive rebounds per game. Extra possessions created; higher is better.',
    'DRB/G': 'Defensive rebounds per game. Ends opponent possessions; higher is better.',
    'BPG': 'Blocks per game. Rim protection / deterrence; higher is better.',
    'SPG': 'Steals per game. Disruption / forcing turnovers; higher is better.',
    'eFG%': 'Effective FG%. Adjusts FG% by giving 3PT extra value: (FGM + 0.5√ó3PM)/FGA.',
    'OR%': 'Offensive Rebound %. Percent of available offensive rebounds a player gets while on court.',
    'DR%': 'Defensive Rebound %. Percent of available defensive rebounds a player gets while on court.',
    'WS': 'Win Shares. Estimated wins contributed (context/team dependent).',
    'Ortg': 'Offensive Rating. Points produced per 100 possessions (higher is better).',
    'DRtg': 'Defensive Rating. Points allowed per 100 possessions while on court; lower is better.',
    'BPM': 'Box Plus/Minus. Overall impact per 100 possessions vs average player (higher is better).',
    'PER': 'Player Efficiency Rating. Box-score efficiency measure (higher is better).'
  };

  function prettyDir(isLower){
    return isLower ? 'Lower is better (‚Üì)' : 'Higher is better (‚Üë)';
  }

const DEFAULT_DIR = {
    'TOPG':'lower',
    'DRtg':'lower',
    'DRTG':'lower',
    'DRTG.':'lower',
    'DRTg':'lower',
    'DRTG':'lower',
    'DRtg':'lower',
    'TOV':'lower',
    'TO':'lower',
    'Fouls':'lower',
    'PF':'lower',
    'Opp PPG':'lower',
    // plus/minus: higher is better generally
    '+/-':'higher'
  };

  function normalizeDirValue(v){
    const s = (v||'').toString().trim().toLowerCase();
    if(s.startsWith('low')) return 'lower';
    if(s.startsWith('high')) return 'higher';
    return '';
  }

  function guessDirForStat(stat){
    const key = (stat||'').toString().trim();
    if(DEFAULT_DIR[key]) return DEFAULT_DIR[key];
    // heuristic: anything ending with 'tg' (ratings) where lower is better for defense
    const k = key.toLowerCase();
    if(k.includes('drtg') || k.includes('def rtg') || k.includes('defrating')) return 'lower';
    if(k.includes('tov') || k.includes('turn')) return 'lower';
    // default
    return 'higher';
  }


function directionLabel(mn, mx, dir){
    const d = normalizeDirValue(dir) || (Number.isFinite(mn) && Number.isFinite(mx) && mn > mx ? 'lower' : 'higher');
    return d === 'lower' ? 'Lower' : 'Higher';
  }

  function getInvertForStat(stat){
    const w = (currentWeights[pos] || []).find(x => x.stat === stat);
    if(!w) return false;
    const d = normalizeDirValue(w.dir);
    if(d) return d === 'lower';
    return Number.isFinite(w.min) && Number.isFinite(w.max) && w.min > w.max;
  }

  
  function updateWeightFooter(){
    const used = (currentWeights[pos] || []).filter(x => (Number(x.w)||0) !== 0);
    const totalW = used.reduce((a,b)=> a + (Number(b.w)||0), 0);
    const remaining = 100 - totalW;
    if(wTotalLocalEl) wTotalLocalEl.textContent = totalW.toFixed(1);
    if(wRemainingEl) wRemainingEl.textContent = remaining.toFixed(1);
    if(wOverBoxEl && wOverEl){
      if(remaining < -1e-9){
        wOverBoxEl.style.display = 'inline-flex';
        wOverEl.textContent = Math.abs(remaining).toFixed(1);
      }else{
        wOverBoxEl.style.display = 'none';
      }
    }
  }

function renderWeights(){
    const wAll = currentWeights[pos] || [];

    // Only show scoring metrics defined in ScoringWeight (column A)
    const selectedOnly = !!showSelectedOnlyEl?.checked;
    let w = wAll.slice();
    if(selectedOnly) w = w.filter(it => (Number(it.w)||0) !== 0);

    // Keep selected metrics at the top
    w = w.slice().sort((a,b)=>{
      const aw = (Number(a.w)||0) !== 0 ? 0 : 1;
      const bw = (Number(b.w)||0) !== 0 ? 0 : 1;
      if(aw !== bw) return aw - bw;
      return a.stat.localeCompare(b.stat);
    });

    weightsBody.innerHTML = '';
    w.forEach((it) => {
      const idx = wAll.findIndex(x => x.stat === it.stat); // stable index into master list
      const tr = document.createElement('tr');
      const selected = (Number(it.w)||0) !== 0;
      tr.style.background = selected ? 'rgba(122,162,255,.08)' : 'transparent';
      tr.innerHTML = `
        <td><span class="statLink" data-stat="${it.stat}">${it.stat}</span></td>
        <td><input type="number" step="0.1" value="${it.w}" data-k="w" data-i="${idx}"/></td>
        <td><input type="number" step="0.001" value="${it.min}" data-k="min" data-i="${idx}"/></td>
        <td><input type="number" step="0.001" value="${it.max}" data-k="max" data-i="${idx}"/></td>
        <td>
          ${(() => {
              const d = normalizeDirValue(it.dir) || (getInvertForStat(it.stat) ? 'lower' : 'higher');
              if(advancedDirEl && advancedDirEl.checked){
                return `<select data-k="dir" data-i="${idx}" style="width:100%; padding:7px 8px; border-radius:12px">
                  <option value="higher" ${(d==='higher')?'selected':''}>Higher</option>
                  <option value="lower" ${(d==='lower')?'selected':''}>Lower</option>
                </select>`;
              }
              const cls = d==='lower' ? 'down' : 'up';
              const title = d==='lower' ? 'Lower is better' : 'Higher is better';
              return `<div class="dirIcon ${cls}" title="${title}"></div>`;
          })()}
        </td>
      `;
      weightsBody.appendChild(tr);
    });
    weightsBody.querySelectorAll('input, select').forEach(inp => {
      inp.addEventListener('input', (e) => {
        const i = Number(e.target.dataset.i);
        const k = e.target.dataset.k;
        const v = Number(e.target.value);
        currentWeights[pos][i][k] = v;
        const row = e.target.closest('tr');
        const it = currentWeights[pos][i];
                // keep list order stable (no reordering). Just update highlight + totals.
        const it2 = currentWeights[pos][i];
        row.style.background = ((Number(it2.w)||0) !== 0) ? 'rgba(122,162,255,.08)' : 'transparent';
        updateWeightFooter();
        if(wb) computeAll();
      });
    });

    const used = (currentWeights[pos] || []).filter(x => (Number(x.w)||0) !== 0);
    const totalW = used.reduce((a,b)=> a + (Number(b.w)||0), 0);
    kpiStats.textContent = String(used.length);
    kpiTotalW.textContent = totalW.toFixed(1);
    updateWeightFooter();
  }


  // ---------- Scoring + valuation ----------
  function scoreRow(r){
    const w = currentWeights[pos] || [];
    const used = w.filter(x => (Number(x.w)||0) !== 0);
    let score = 0;

    used.forEach(rule => {
      const raw = r[rule.stat];
      if(raw === undefined || raw === null || raw === '') return;
      let x = safeNum(raw);
      if(x === null) return;

      // Percent scaling (whole-number % -> decimal) to match your Excel conventions
      x = scalePct(rule.stat, x);

      // Ensure we have a valid range
      let mn = Number(rule.min);
      let mx = Number(rule.max);

      mn = scalePct(rule.stat, mn);
      mx = scalePct(rule.stat, mx);

      if(!Number.isFinite(mn) || !Number.isFinite(mx) || mn === mx){
        return;
      }
      // Always treat range as [lo, hi]
      const lo = Math.min(mn, mx);
      const hi = Math.max(mn, mx);
      let val = (x - lo) / (hi - lo); // higher-is-better normalized

      // If lower-is-better, invert
      const lowerBetter = getInvertForStat(rule.stat);
      if(lowerBetter) val = 1 - val;

      score += rule.w * clamp01(val);
    });

    return score;
  }

  function getMpMultiplier(mp, mpPctl){
    if(mpModeEl.value === 'off') return 1;
    if(!Number.isFinite(mp) || mp <= 0) return 0;
    if(!Number.isFinite(mpPctl) || mpPctl <= 0) return 1;
    return Math.min(1, Math.sqrt(mp / mpPctl));
  }

  function buildStatDistributions(){
    statDist = {};
    // Use union of stats in the current weights plus common ones used in fit presets
    const fromWeights = (currentWeights[pos] || []).map(x => x.stat);
    const fromFit = Object.keys(FIT_PRESETS.balanced);
    const stats = Array.from(new Set([...fromWeights, ...fromFit])).filter(Boolean);

    stats.forEach(stat => {
      const arr = computed.map(r => safeNum(r[stat])).filter(Number.isFinite);
      if(arr.length < 5) return;
      const sorted = arr.slice().sort((a,b)=>a-b);
      statDist[stat] = {sorted, invert: getInvertForStat(stat)};
    });
  }

  function statPercentile(stat, x){
    const d = statDist[stat];
    if(!d) return NaN;
    let p = percentileRank(d.sorted, x); // 0..1 (higher value => higher percentile)
    if(d.invert) p = 1 - p;              // lower is better => invert
    return clamp(p, 0, 1);
  }

  function fitScoreForRow(r){
    const presetKey = fitPresetEl.value;
    const preset = FIT_PRESETS[presetKey] || FIT_PRESETS.balanced;

    let num = 0, den = 0;
    for(const [stat, w] of Object.entries(preset)){
      if(!w) continue;
      const x = safeNum(r[stat]);
      if(x === null) continue;
      const p = statPercentile(stat, x);
      if(!Number.isFinite(p)) continue;
      num += w * p;
      den += w;
    }
    if(den === 0) return NaN;
    return 100 * (num / den);
  }

  function archetypeTags(r){
    // Use percentiles for tagging
    const p = (stat) => {
      const x = safeNum(r[stat]);
      if(x === null) return NaN;
      return statPercentile(stat, x);
    };

    const tags = [];
    if(pos === 'Guards'){
      const p3 = p('3P%'), pefg = p('eFG%'), pft = p('FT%'), pppg = p('PPG');
      const papg = p('APG'), pato = p('A/TO'), ptopg = p('TOPG');
      const pspg = p('SPG'), pdr = p('DR%'), pbpm = p('BPM');

      if(Number.isFinite(p3) && p3 >= 0.80) tags.push({t:'Shooter', c:'var(--accent2)'});
      if(Number.isFinite(pefg) && pefg >= 0.80) tags.push({t:'Efficient', c:'var(--good)'});
      if(Number.isFinite(pppg) && pppg >= 0.80) tags.push({t:'Scorer', c:'var(--accent)'});
      if(Number.isFinite(papg) && papg >= 0.80) tags.push({t:'Playmaker', c:'var(--accent2)'});
      if(Number.isFinite(pato) && pato >= 0.75) tags.push({t:'Low TO', c:'var(--good)'});
      if(Number.isFinite(pspg) && pspg >= 0.80) tags.push({t:'Disruptor', c:'var(--warn)'});
      if(Number.isFinite(pdr) && pdr >= 0.75) tags.push({t:'Defender', c:'var(--warn)'});
      if(Number.isFinite(pbpm) && pbpm >= 0.75) tags.push({t:'Impact', c:'var(--accent)'});

      if(tags.length === 0) tags.push({t:'Role Player', c:'var(--muted)'});
      return tags.slice(0, 6);
    }else{
      const pbpg = p('BPG'), pdrtg = p('DRtg'), pdr = p('DR%'), por = p('OR%'), pdrb = p('DRB/G');
      const pefg = p('eFG%'), p3 = p('3P%');

      if(Number.isFinite(pbpg) && pbpg >= 0.80) tags.push({t:'Rim Protector', c:'var(--warn)'});
      if((Number.isFinite(pdr) && pdr >= 0.80) || (Number.isFinite(pdrb) && pdrb >= 0.80)) tags.push({t:'Rebounder', c:'var(--accent2)'});
      if(Number.isFinite(pdrtg) && pdrtg >= 0.75) tags.push({t:'Anchor Defender', c:'var(--warn)'});
      if(Number.isFinite(pefg) && pefg >= 0.80) tags.push({t:'Efficient Finisher', c:'var(--good)'});
      if(Number.isFinite(por) && por >= 0.75) tags.push({t:'Extra Possessions', c:'var(--accent)'});
      if(Number.isFinite(p3) && p3 >= 0.75) tags.push({t:'Stretch Big', c:'var(--accent2)'});

      if(tags.length === 0) tags.push({t:'Frontcourt Role', c:'var(--muted)'});
      return tags.slice(0, 6);
    }
  }

  // ---------- Conference multiplier ----------
  // Canonical display list (one entry per conference, in order)
  const CONF_DISPLAY_ORDER = [
    'Big 12','SEC','Big Ten','ACC','Big East',
    'American','Mountain West','Atlantic 10','WCC',
    'Missouri Valley','CUSA','MAC','Sun Belt',
    'CAA','Ivy League','Big West','Summit League',
    'Horizon League','America East','Southern',
    'ASUN','MAAC','OVC','WAC','Patriot League',
    'Big Sky','Southland','NEC','SWAC','MEAC',
    'Big South','Independent','NE10'
  ];

  const DEFAULT_CONF_VALUES = {
    'Big 12':1.08,'SEC':1.07,'Big Ten':1.07,'ACC':1.06,'Big East':1.06,
    'American':1.05,'Mountain West':1.05,'Atlantic 10':1.04,'WCC':1.04,
    'Missouri Valley':1.03,'CUSA':1.03,'MAC':1.00,'Sun Belt':1.01,
    'CAA':1.00,'Ivy League':1.00,'Big West':0.99,'Summit League':0.99,
    'Horizon League':0.99,'America East':0.98,'Southern':0.98,
    'ASUN':0.97,'MAAC':0.97,'OVC':0.96,'WAC':0.96,'Patriot League':0.96,
    'Big Sky':0.96,'Southland':0.95,'NEC':0.94,'SWAC':0.93,'MEAC':0.93,
    'Big South':0.94,'Independent':1.00,'NE10':0.90
  };

  // Alias map: maps alternate spellings ‚Üí canonical name
  const CONF_ALIASES = {
    'Mountain We':'Mountain West','A-10':'Atlantic 10',
    'Missouri Vall':'Missouri Valley','MVC':'Missouri Valley',
    'C-USA':'CUSA','Conference USA':'CUSA',
    'Ivy':'Ivy League','Summit Leag':'Summit League',
    'Horizon Leag':'Horizon League','America Eas':'America East',
    'SoCon':'Southern','A-Sun':'ASUN',
    'Ohio Valley':'OVC','Patriot Leag':'Patriot League','Patriot':'Patriot League',
    'Northeast':'NEC','NE-10':'NE10','Northeast-10':'NE10'
  };

  // Live working copy (user-editable) ‚Äî keyed by canonical name only
  let confMultipliers = JSON.parse(JSON.stringify(DEFAULT_CONF_VALUES));
  const confMultToggleEl = document.getElementById('confMultToggle');
  const confMultBodyEl = document.getElementById('confMultBody');
  const confMultTableBody = document.getElementById('confMultTableBody');
  const confMultRangeEl = document.getElementById('confMultRange');
  const confMultLeagueNote = document.getElementById('confMultLeagueNote');
  const resetConfMultBtn = document.getElementById('resetConfMult');

  function renderConfMultTable(){
    const isOn = confMultToggleEl.checked;
    confMultBodyEl.style.opacity = isOn ? '1' : '0.4';
    confMultBodyEl.style.pointerEvents = isOn ? 'auto' : 'none';
    confMultLeagueNote.textContent = league === 'WBB' ? '(WBB ‚Äî will activate when conference column detected)' : '';

    confMultTableBody.innerHTML = '';
    CONF_DISPLAY_ORDER.forEach(conf => {
      const mult = confMultipliers[conf] ?? 1;
      const tr = document.createElement('tr');
      const isMac = conf === 'MAC';
      tr.innerHTML = `
        <td style="font-weight:${isMac?'700':'500'};${isMac?'color:var(--accent)':''}">${conf}${isMac ? ' (baseline)' : ''}</td>
        <td><input type="number" step="0.01" min="0.5" max="1.5" value="${mult.toFixed(2)}" class="confMult-input" data-conf="${conf}" style="${mult>1?'color:var(--good)':mult<1?'color:var(--bad)':'color:var(--text)'}"></td>
      `;
      confMultTableBody.appendChild(tr);
    });

    confMultTableBody.querySelectorAll('.confMult-input').forEach(inp => {
      inp.addEventListener('input', (e) => {
        const conf = e.target.dataset.conf;
        const val = parseFloat(e.target.value);
        if(!Number.isFinite(val)) return;
        confMultipliers[conf] = val;
        e.target.style.color = val > 1 ? 'var(--good)' : val < 1 ? 'var(--bad)' : 'var(--text)';
        updateConfMultRange();
        if(wb) computeAll();
      });
    });

    updateConfMultRange();
  }

  function updateConfMultRange(){
    const vals = CONF_DISPLAY_ORDER.map(c => confMultipliers[c] ?? 1);
    const mn = Math.min(...vals), mx = Math.max(...vals);
    confMultRangeEl.textContent = `${mn.toFixed(2)} ‚Äì ${mx.toFixed(2)}`;
  }

  confMultToggleEl.addEventListener('change', ()=>{
    renderConfMultTable();
    if(wb) computeAll();
  });

  resetConfMultBtn.addEventListener('click', ()=>{
    confMultipliers = JSON.parse(JSON.stringify(DEFAULT_CONF_VALUES));
    renderConfMultTable();
    if(wb) computeAll();
  });

  // Lookup: resolve a conference string to its canonical name, then get multiplier
  function getConfMultiplier(confStr){
    if(!confStr) return 1;
    const c = confStr.toString().trim();
    // Direct match on canonical name
    if(confMultipliers[c] !== undefined) return confMultipliers[c];
    // Check alias map
    const alias = CONF_ALIASES[c];
    if(alias && confMultipliers[alias] !== undefined) return confMultipliers[alias];
    // Case-insensitive match on canonical names
    const cl = c.toLowerCase();
    for(const name of CONF_DISPLAY_ORDER){
      if(name.toLowerCase() === cl) return confMultipliers[name] ?? 1;
    }
    // Case-insensitive alias
    for(const [ak, av] of Object.entries(CONF_ALIASES)){
      if(ak.toLowerCase() === cl) return confMultipliers[av] ?? 1;
    }
    // Partial/contains match as last resort
    for(const name of CONF_DISPLAY_ORDER){
      if(cl.includes(name.toLowerCase()) || name.toLowerCase().includes(cl)) return confMultipliers[name] ?? 1;
    }
    return 1;
  }

  // Determine if current sheet has conference data
  function sheetHasConference(){
    if(!rows || !rows.length) return false;
    return rows.some(r => {
      const c = (r['Conference'] ?? r['Conf'] ?? '').toString().trim();
      return c.length > 0;
    });
  }

  // Init render
  renderConfMultTable();

  function computeAll(){
    // Make sure weight table includes every numeric stat in the current sheet
    ensureWeightsCoverStats(pos, rows);

    if(!rows.length) { computed = []; renderPlayers(); return; }

    // Determine if conference multiplier should be applied
    const confMultOn = confMultToggleEl.checked && sheetHasConference();

    computed = rows.map(r => {
      const perf = scoreRow(r);
      const mp = safeNum(r['MP']);
      const conf = (r['Conference'] ?? r['Conf'] ?? '').toString().trim();
      const cm = confMultOn ? getConfMultiplier(conf) : 1;
      const adjPerf = perf * cm;
      return {...r, PerfScore_calc: adjPerf, PerfScore_raw: perf, ConfMult_calc: cm, MP_num: mp};
    });

    const perfArr = computed.map(r => r.PerfScore_calc).filter(Number.isFinite);
    lastPerfAvg = perfArr.reduce((a,b)=>a+b,0) / (perfArr.length || 1);

    const starP = clamp(Number(starPctEl.value), 0.5, 0.999);
    lastPerfStar = percentileInc(perfArr, starP);

    const mpP = clamp(Number(mpPctEl.value), 0.5, 0.999);
    const mpArr = computed.map(r => r.MP_num).filter(Number.isFinite);
    const mpPctl = percentileInc(mpArr, mpP);

    const avgPay = Number(avgPayEl.value);
    const minPay = Number(minPayEl.value);
    const maxPay = Number(maxPayEl.value);
    const starValue = Number(starValueEl.value);

    let k = 0;
    const denom = (lastPerfStar - lastPerfAvg);
    if(Number.isFinite(starValue) && Number.isFinite(avgPay) && avgPay > 0 && Number.isFinite(denom) && Math.abs(denom) > 1e-9){
      k = Math.log(starValue / avgPay) / denom;
    }

    computed = computed.map(r => {
      const perf = r.PerfScore_calc;
      const mp = r.MP_num;

      let pred = NaN, final = NaN, mult = 1;
      if(Number.isFinite(perf) && Number.isFinite(avgPay) && avgPay > 0){
        pred = avgPay * Math.exp(k * (perf - lastPerfAvg));
        pred = clamp(pred, minPay, maxPay);
        mult = getMpMultiplier(mp, mpPctl);
        final = clamp(pred * mult, minPay, maxPay);
      }
      return {...r,
        Score: perf,
        PredictedValue_calc: pred,
        MinMultiplier_calc: mult,
        ActualValuation_calc: final
      };
    });

    // Build percentile distributions and fit scores
    buildStatDistributions();
    computed = computed.map(r => ({...r, FitScore_calc: fitScoreForRow(r)}));

    // --- Boss fields (optional) + our ranking ---
    function pickActualValuation(row){
      // Try a few likely columns from the workbook (your boss's valuation)
      const keys = ['Valuation','Value','ActualValuation','ActualValuation','PredictedValue','Pay','Salary'];
      for(const k of keys){
        const v = safeNum(row[k]);
        if(Number.isFinite(v)) return v;
      }
      return NaN;
    }

    computed = computed.map(r => {
      const bossRank = safeNum(r['Rank']);
      const bossVal = pickActualValuation(r);
      const delta = (Number.isFinite(bossVal) && Number.isFinite(r.ActualValuation_calc)) ? (r.ActualValuation_calc - bossVal) : NaN;
      const deltaPct = (Number.isFinite(delta) && Number.isFinite(bossVal) && bossVal !== 0) ? (delta / bossVal) : NaN;
      return {...r, BossRank: bossRank, ActualValuation: bossVal, ValueDelta_calc: delta, ValueDeltaPct_calc: deltaPct};
    });

    // Rank by PerfScore (desc), tie-break by FitScore (desc)
    const ranked = computed.slice().sort((a,b)=>{
      const pa = a.PerfScore_calc, pb = b.PerfScore_calc;
      const fa = a.FitScore_calc, fb = b.FitScore_calc;
      if(Number.isFinite(pa) && Number.isFinite(pb) && pa !== pb) return pb - pa;
      if(Number.isFinite(fa) && Number.isFinite(fb) && fa !== fb) return fb - fa;
      return String(a.Player||'').localeCompare(String(b.Player||''));
    });
    ranked.forEach((r,i)=>{ r.CalcRank = i + 1; });

    // KPIs
    kpiPlayers.textContent = String(computed.length);
    kpiAvgPerf.textContent = Number.isFinite(lastPerfAvg) ? lastPerfAvg.toFixed(2) : '‚Äî';
    kpiStarPerf.textContent = Number.isFinite(lastPerfStar) ? lastPerfStar.toFixed(2) : '‚Äî';

    renderPlayers();
  }

  // ---------- Table rendering ----------
  const LIST_COLS = [
    {key:'CalcRank', label:'Rank'},
    {key:'Player', label:'Player'},
    {key:'Team', label:'Team'},
    {key:'Conference', label:'Conf'},
    {key:'ConfMult_calc', label:'C.Mult'},
    {key:'MP', label:'MP'},
    {key:'Score', label:'Perf'},
    {key:'FitScore_calc', label:'Fit'},
    {key:'ActualValuation_calc', label:'Model $'},
    {key:'ActualValuation', label:'Actual $'},
    {key:'ValueDelta_calc', label:'Œî$'},
  ];

  function sortData(data){
    const k = sort.key;
    const dir = sort.dir;
    return data.slice().sort((a,b)=>{
      const av = a[k]; const bv = b[k];
      const an = Number(av); const bn = Number(bv);
      let cmp;
      if(Number.isFinite(an) && Number.isFinite(bn)) cmp = an - bn;
      else cmp = (av ?? '').toString().localeCompare((bv ?? '').toString());
      return dir === 'asc' ? cmp : -cmp;
    });
  }

  // ---------- Pagination ----------
  const PAGE_SIZE = 200;
  let currentPage = 0;
  let filteredData = [];

  function renderPlayers(){
    const q = (searchInput.value || '').toLowerCase().trim();
    let data = computed;
    if(q){
      data = data.filter(r => {
        return ['Player','Team','Conference','Position'].some(k => (r[k] ?? '').toString().toLowerCase().includes(q));
      });
    }
    filteredData = sortData(data);
    currentPage = 0;
    playersHead.innerHTML = ''; // force header rebuild
    renderPlayersPage();
  }

  function renderPlayersPage(){
    // Header (only rebuild if empty)
    if(!playersHead.children.length){
      const frag = document.createDocumentFragment();
      LIST_COLS.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c.label;
        th.addEventListener('click', ()=>{
          if(sort.key === c.key) sort.dir = (sort.dir === 'asc' ? 'desc' : 'asc');
          else { sort.key = c.key; sort.dir = (c.key === 'ActualValuation_calc' || c.key === 'Score' || c.key === 'FitScore_calc') ? 'desc' : 'asc'; }
          filteredData = sortData(filteredData);
          currentPage = 0;
          renderPlayersPage();
        });
        frag.appendChild(th);
      });
      playersHead.innerHTML = '';
      playersHead.appendChild(frag);
    }

    const start = currentPage * PAGE_SIZE;
    const pageData = filteredData.slice(start, start + PAGE_SIZE);
    const totalPages = Math.ceil(filteredData.length / PAGE_SIZE);

    // Build rows with DocumentFragment (single DOM write)
    const frag = document.createDocumentFragment();
    pageData.forEach(r => {
      const tr = document.createElement('tr');
      LIST_COLS.forEach(c => {
        const td = document.createElement('td');
        let v = r[c.key];
        if(c.key === 'ActualValuation_calc' || c.key === 'ActualValuation' || c.key === 'ValueDelta_calc'){
          const n = safeNum(v);
          if(!Number.isFinite(n)) v = '‚Äî';
          else if(c.key === 'ValueDelta_calc') v = (n>=0?'+':'') + fmtMoney(n).replace('$','');
          else v = fmtMoney(n);
        }
        if(c.key === 'Player'){
          td.innerHTML = `<span class="link">${(v ?? '').toString()}</span>`;
          td.querySelector('.link').addEventListener('click', ()=> openProfile(r));
        }else if(c.key === 'ConfMult_calc'){
          const cm = safeNum(r.ConfMult_calc);
          if(Number.isFinite(cm) && cm !== 1){
            td.textContent = cm.toFixed(2);
            td.style.color = cm > 1 ? 'var(--good)' : 'var(--bad)';
            td.style.fontWeight = '700';
          } else {
            td.textContent = Number.isFinite(cm) ? cm.toFixed(2) : '‚Äî';
          }
        }else if(c.key === 'Score' && Number.isFinite(Number(r.Score))){
          td.textContent = Number(r.Score).toFixed(2);
        }else if(c.key === 'FitScore_calc'){
          td.textContent = Number.isFinite(r.FitScore_calc) ? r.FitScore_calc.toFixed(0) : '‚Äî';
        }else if(c.key === 'ActualValuation_calc'){
          td.textContent = fmtMoney(r.ActualValuation_calc);
        }else{
          td.textContent = (v ?? '').toString();
        }
        tr.appendChild(td);
      });
      frag.appendChild(tr);
    });
    playersBody.innerHTML = '';
    playersBody.appendChild(frag);

    // Pagination controls
    let pag = document.getElementById('pagControls');
    if(!pag){
      pag = document.createElement('div');
      pag.id = 'pagControls';
      pag.style.cssText = 'display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:10px;flex-wrap:wrap';
      playersBody.closest('.card').insertBefore(pag, playersBody.closest('.scrollY').nextSibling);
    }
    if(totalPages <= 1){
      pag.innerHTML = `<span class="pill" style="font-size:11px">${filteredData.length} players</span>`;
    } else {
      pag.innerHTML = `
        <span class="pill" style="font-size:11px">Showing ${start+1}‚Äì${Math.min(start+PAGE_SIZE, filteredData.length)} of ${filteredData.length}</span>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="secondary" id="pagPrev" style="padding:6px 12px;font-size:11px" ${currentPage===0?'disabled':''}>‚Üê Prev</button>
          <span style="font-size:11px;color:var(--muted)">Page ${currentPage+1} / ${totalPages}</span>
          <button class="secondary" id="pagNext" style="padding:6px 12px;font-size:11px" ${currentPage>=totalPages-1?'disabled':''}>Next ‚Üí</button>
        </div>`;
      document.getElementById('pagPrev')?.addEventListener('click',()=>{if(currentPage>0){currentPage--;renderPlayersPage();}});
      document.getElementById('pagNext')?.addEventListener('click',()=>{if(currentPage<totalPages-1){currentPage++;renderPlayersPage();}});
    }
  }

  // Debounced search (150ms)
  let _searchTimer = null;
  function debouncedSearch(){
    clearTimeout(_searchTimer);
    _searchTimer = setTimeout(renderPlayers, 150);
  }

  // ---------- Profile modal ----------
  function barColor(p){
    if(!Number.isFinite(p)) return 'var(--muted)';
    if(p >= 0.80) return 'var(--good)';
    if(p >= 0.60) return 'var(--accent2)';
    if(p >= 0.40) return 'var(--accent)';
    return 'var(--bad)';
  }

  function openProfile(r){
    const player = (r['Player'] ?? 'Player').toString();
    const team = (r['Team'] ?? '').toString();
    const conf = (r['Conference'] ?? r['Conf'] ?? '').toString();
    const position = (r['Position'] ?? pos).toString();

    mTitle.textContent = player;
    mSub.textContent = [team, conf, position].filter(Boolean).join(' ‚Ä¢ ');
    document.getElementById('mLearnMore').href = 'https://www.google.com/search?q=' + encodeURIComponent(player + ' ' + team + ' basketball');
    mScore.textContent = Number.isFinite(r.Score) ? r.Score.toFixed(2) : '‚Äî';
    mFit.textContent = Number.isFinite(r.FitScore_calc) ? r.FitScore_calc.toFixed(0) : '‚Äî';
    mVal.textContent = fmtMoney(r.ActualValuation_calc);
    mMult.textContent = Number.isFinite(r.MinMultiplier_calc) ? r.MinMultiplier_calc.toFixed(2) : '‚Äî';

    // Conference multiplier row in modal
    const mConfMultRow = document.getElementById('mConfMultRow');
    const cm = safeNum(r.ConfMult_calc);
    if(Number.isFinite(cm) && cm !== 1 && confMultToggleEl.checked){
      mConfMultRow.style.display = 'block';
      document.getElementById('mConfMult').textContent = cm.toFixed(2);
      document.getElementById('mConfName').textContent = conf || '‚Äî';
    } else {
      mConfMultRow.style.display = 'none';
    }

    const bossVal = safeNum(r.ActualValuation);
    const delta = safeNum(r.ValueDelta_calc);
    const deltaPct = safeNum(r.ValueDeltaPct_calc);
    let bossLine = '';
    if(Number.isFinite(bossVal)){
      const sign = Number.isFinite(delta) ? (delta>=0?'+':'') : '';
      const pctTxt = Number.isFinite(deltaPct) ? ` (${(deltaPct*100).toFixed(1)}%)` : '';
      bossLine = `Actual valuation: <b>${fmtMoney(bossVal)}</b> ‚Ä¢ Model vs Boss: <b>${sign}${fmtMoney(delta).replace('$','')}</b>${pctTxt}`;
    }


    if(bossLine){ mMeta.innerHTML = `<div class="muted">${bossLine}</div>`; }

    // tags
    mTags.innerHTML = '';
    

    // Fill role definitions list (under valuation)
    const roleDefsEl = document.getElementById('mRoleDefs');
    if(roleDefsEl){
      const labels = [...new Set(archetypeTags(r).map(x => x.t).filter(Boolean))];
      roleDefsEl.innerHTML = labels.map(lbl => {
        const desc = ROLE_DESCRIPTIONS[lbl] || "Definition not set.";
        return `<div style="display:flex; gap:10px; align-items:flex-start">
          <span class="pill" style="flex:0 0 auto">${lbl}</span>
          <div class="hint" style="margin:0; opacity:.95">${desc}</div>
        </div>`;
      }).join('') || `<div class="hint" style="margin:0">No role tags for this player.</div>`;
    }
archetypeTags(r).forEach(tag=>{
      const div = document.createElement('div');
      div.className = 'chip';
      div.innerHTML = `<span class="dot" style="background:${tag.c}"></span>${tag.t}`;
      mTags.appendChild(div);
    });

    // key bars (show the stats from your weights with weight>0, capped)
    const usedStats = (currentWeights[pos] || []).filter(x => (Number(x.w)||0) !== 0).map(x=>x.stat);
    const fallback = ['PPG','eFG%','3P%','FT%','APG','A/TO','TOPG','SPG','BPG','DRtg','DR%','WS/40','BPM','PER'];
    const stats = Array.from(new Set([...usedStats, ...fallback])).filter(s => r[s] !== undefined).slice(0, 10);

    mBars.innerHTML = '';
    stats.forEach(stat=>{
      const x = safeNum(r[stat]);
      const pct = statPercentile(stat, x);
      const item = document.createElement('div');
      item.className = 'barItem';
      const pctLabel = Number.isFinite(pct) ? `${Math.round(pct*100)}th` : '‚Äî';
      item.innerHTML = `
        <div class="barTop"><div><b>${stat}</b> <span class="muted">${(r[stat] ?? '‚Äî')}</span></div><div>${pctLabel}</div></div>
        <div class="barTrack"><div class="barFill"></div></div>
        <div class="barMeta"><span>${getInvertForStat(stat) ? 'Lower is better' : 'Higher is better'}</span><span class="muted">${fitPresetEl.options[fitPresetEl.selectedIndex].text}</span></div>
      `;
      const fill = item.querySelector('.barFill');
      fill.style.width = Number.isFinite(pct) ? `${Math.round(pct*100)}%` : `0%`;
      fill.style.background = `linear-gradient(90deg, ${barColor(pct)}, var(--accent2))`;
      mBars.appendChild(item);
    });

    // valuation meta + star anchor explanation
    const avgPay = Number(avgPayEl.value);
    const starValue = Number(starValueEl.value);
    const starP = clamp(Number(starPctEl.value), 0.5, 0.999);
    mMeta.innerHTML = `
      <div class="muted">
        Star anchor: at PerfScore <b>${starP.toFixed(2)} percentile</b> (~<b>${Number.isFinite(lastPerfStar)?lastPerfStar.toFixed(2):'‚Äî'}</b>),
        predicted pay is pulled toward <b>${fmtMoney(starValue)}</b>, with average anchored at <b>${fmtMoney(avgPay)}</b>.
        More starValue ‚Üí steeper curve (bigger top-end).
      </div>
    `;

    // All stats
    const exclude = new Set(['PerfScore_calc','PredictedValue_calc','ActualValuation_calc','MinMultiplier_calc','MP_num','FitScore_calc']);
    const all = Object.keys(r).filter(k => !exclude.has(k));
    const container = document.createElement('div');
    container.className = 'panel';
    container.style.border = 'none';
    container.style.borderRadius = '0';
    container.innerHTML = '';
    all.forEach(k => {
      const div = document.createElement('div');
      div.className = 'statRow';
      div.innerHTML = `<span class="k">${k}</span><span>${(r[k] ?? '‚Äî')}</span>`;
      container.appendChild(div);
    });
    mAllStats.innerHTML = '';
    mAllStats.appendChild(container);

    modalBack.style.display = 'flex';
  }

  function closeProfile(){ modalBack.style.display = 'none'; }

  function openStatInfo(stat){
    const statBack = document.getElementById('statBack');
    const sClose = document.getElementById('sClose');
    const sTitle = document.getElementById('sTitle');
    const sDir = document.getElementById('sDir');
    const sDesc = document.getElementById('sDesc');
    const sMin = document.getElementById('sMin');
    const sMax = document.getElementById('sMax');
    const sDir2 = document.getElementById('sDir2');
    const sTip = document.getElementById('sTip');

    if(!statBack) { showWarn('Stat glossary modal not found in DOM.'); return; }

    const rule = (currentWeights[pos] || []).find(x => x.stat === stat);
    const isLower = getInvertForStat(stat);
    const desc = STAT_GLOSSARY[stat] || 'No description yet for this metric.';

    if(sTitle) sTitle.textContent = stat;
    if(sDir) sDir.textContent = prettyDir(isLower);
    if(sDir2) sDir2.textContent = prettyDir(isLower);
    if(sDesc) sDesc.textContent = desc;
    if(sMin) sMin.textContent = (rule && Number.isFinite(Number(rule.min))) ? Number(rule.min) : '‚Äî';
    if(sMax) sMax.textContent = (rule && Number.isFinite(Number(rule.max))) ? Number(rule.max) : '‚Äî';
    if(sTip) sTip.textContent = 'Tip: Set Min/Max to realistic bounds (or percentiles) so normalization is stable.';

    // attach close handlers once
    if(sClose && !sClose._bound){
      sClose.addEventListener('click', ()=> closeStatInfo());
      sClose._bound = true;
    }
    if(!statBack._bound){
      statBack.addEventListener('click', (e)=>{ if(e.target === statBack) closeStatInfo(); });
      statBack._bound = true;
    }

    statBack.style.display = 'flex';
  }

  function closeStatInfo(){
    const statBack = document.getElementById('statBack');
    if(statBack) statBack.style.display = 'none';
  }

  mClose.addEventListener('click', closeProfile);
  modalBack.addEventListener('click', (e)=>{ if(e.target === modalBack) closeProfile(); });
  window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ closeProfile(); closeStatInfo(); } });

  // ---------- League/pos tabs ----------
  document.getElementById('tabMBB').addEventListener('click', ()=>{
    league = 'MBB';
    setActiveTab(document.getElementById('tabMBB'), '.tab[data-league]');
    applyLeagueDefaults(false);
    renderConfMultTable();
    reloadActiveSheet();
  });
  document.getElementById('tabWBB').addEventListener('click', ()=>{
    league = 'WBB';
    setActiveTab(document.getElementById('tabWBB'), '.tab[data-league]');
    applyLeagueDefaults(false);
    renderConfMultTable();
    reloadActiveSheet();
  });
  document.getElementById('tabGuards').addEventListener('click', ()=>{
    pos = 'Guards';
    setActiveTab(document.getElementById('tabGuards'), '.tab[data-pos]');
    renderWeights();
    reloadActiveSheet();
  });
  document.getElementById('tabBigs').addEventListener('click', ()=>{
    pos = 'Bigs';
    setActiveTab(document.getElementById('tabBigs'), '.tab[data-pos]');
    renderWeights();
    reloadActiveSheet();
  });

  fitPresetEl.addEventListener('change', ()=>{
    activeFitEl.textContent = fitPresetEl.options[fitPresetEl.selectedIndex].text;
    if(wb) { computed = computed.map(r => ({...r, FitScore_calc: fitScoreForRow(r)})); renderPlayers(); }
  });

  function applyLeagueDefaults(force){
    if(league === 'MBB'){
      if(force || avgPayEl.value === '' || Number(avgPayEl.value) === 35000){
        avgPayEl.value = 70000; minPayEl.value = 10000; maxPayEl.value = 300000;
      }
    }else{
      if(force || avgPayEl.value === '' || Number(avgPayEl.value) === 70000){
        avgPayEl.value = 35000; minPayEl.value = 5000; maxPayEl.value = 150000;
      }
    }
  }

  // ---------- Sheet selection ----------
  function reloadActiveSheet(){
    if(!wb) return;
    clearWarn();
    const desired = SHEET_MAP[league][pos];
    const sheetName = findSheetLike(desired) || desired;
    activeSheetEl.textContent = sheetName;

    const ws = wb.Sheets[sheetName];
    if(!ws){
      showWarn(`Could not find sheet "${sheetName}" in the workbook. Check sheet names.`);
      rows = [];
      computed = [];
      renderPlayers();
      return;
    }
    rows = parseSheetToRows(ws);
    ensureWeightsCoverStats(pos, rows);
    renderWeights();
    computeAll();
  }

  // ---------- File load ----------
  
  if(loadGsBtn){
    loadGsBtn.addEventListener('click', async ()=>{
      const key = gsKeyInput?.value?.trim() || DEFAULT_GS_API_KEY;
      await loadFromGoogleSheets(DEFAULT_GS_URL, key);
    });
  }
  // (File upload handler removed ‚Äî data loads from Google Sheets only)
  // ---------- Buttons + live updates ----------
  recalcBtn.addEventListener('click', ()=>{ if(wb) computeAll(); });

  resetWeightsBtn.addEventListener('click', ()=>{
    // Reset to your Excel defaults, but keep any extra stats (with W=0) available in this sheet.
    const base = JSON.parse(JSON.stringify(excelWeights));
    currentWeights[pos] = base[pos] || [];
    ensureWeightsCoverStats(pos, rows);
    renderWeights();
    computeAll();
  });

  resetValBtn.addEventListener('click', ()=>{
    applyLeagueDefaults(true);
    starValueEl.value = 100000;
    starPctEl.value = 0.95;
    mpModeEl.value = 'on';
    mpPctEl.value = 0.95;
    computeAll();
  });

  function exportCSV(){
    const cols = ['Rank','Player','Team','Conference','ConfMult_calc','Position','MP','Score','FitScore_calc','PredictedValue_calc','MinMultiplier_calc','ActualValuation_calc'];
    const lines = [];
    lines.push(cols.map(c => `"${c.replaceAll('"','""')}"`).join(','));
    computed.forEach(r => {
      const row = cols.map(c => `"${(r[c] ?? '').toString().replaceAll('"','""')}"`).join(',');
      lines.push(row);
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `scouting_${league.toLowerCase()}_${pos.toLowerCase()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }
  exportBtn.addEventListener('click', exportCSV);

  searchInput.addEventListener('input', debouncedSearch);
  showSelectedOnlyEl.addEventListener('change', renderWeights);
  advancedDirEl.addEventListener('change', renderWeights);


  [avgPayEl,minPayEl,maxPayEl,starValueEl,starPctEl,mpModeEl,mpPctEl].forEach(el=>{
    el.addEventListener('input', ()=>{ if(wb) computeAll(); });
    el.addEventListener('change', ()=>{ if(wb) computeAll(); });
  });

  // Auto-load default Google Sheet on startup
  window.addEventListener('DOMContentLoaded', () => {
    if(gsKeyInput) gsKeyInput.value = DEFAULT_GS_API_KEY;
    setTimeout(() => loadFromGoogleSheets(DEFAULT_GS_URL, DEFAULT_GS_API_KEY), 80);
  });
</script>
<!-- Stat glossary modal -->
<div class="modalBack" id="statBack">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div>
        <div class="modalTitle" id="sTitle">Stat</div>
        <div class="modalSub" id="sDir">‚Äî</div>
      </div>
      <button class="close" id="sClose">Close</button>
    </div>
    <div class="modalBody">
      <div class="panel">
        <div class="panelHead">What it measures</div>
        <div class="panelBody">
          <div class="hint" id="sDesc" style="margin-top:0">‚Äî</div>
          <div class="divider"></div>
          <div class="row" style="gap:10px;flex-wrap:wrap">
            <span class="pill">Current Min: <b id="sMin">‚Äî</b></span>
            <span class="pill">Current Max: <b id="sMax">‚Äî</b></span>
            <span class="pill">Direction: <b id="sDir2">‚Äî</b></span>
          </div>
          <div class="hint" id="sTip">Tip: use Min/Max to normalize players into a 0‚Äì1 scale before weighting.</div>
        </div>
      </div>
    </div>
  </div>
</div>

	</body>

</html>
